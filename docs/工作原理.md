# Agent Maestro 工作原理

## 一句话概括

外部 AI 工具（Claude Code、Codex、Gemini CLI）发送它们各自格式的 API 请求 → Agent Maestro 翻译成 VS Code 的语言模型 API → 拿到响应后再翻译回原始格式返回。

## 数据流

```
Claude Code / Codex / Gemini CLI
        │
        │  各自的原生 API 格式
        ▼
┌─────────────────────────┐
│  ProxyServer (端口 23333) │  ← Hono HTTP 服务器
│  ├─ /api/anthropic/*    │  ← Anthropic 格式
│  ├─ /api/openai/*       │  ← OpenAI 格式
│  └─ /api/gemini/*       │  ← Gemini 格式
└───────────┬─────────────┘
            │  格式转换
            ▼
   VS Code LanguageModelChat API
            │
            ▼
   Copilot / 其他 LM 提供者
            │
            ▼
   响应转换回原始格式 → SSE 流式返回给调用方
```

## 三个核心部分

### 1. ProxyServer

HTTP 服务器，同时暴露 Anthropic、OpenAI、Gemini 三种 API 格式的端点。本质上是个**格式翻译器**。

- 端口默认 `23333`，可通过环境变量 `AGENT_MAESTRO_PROXY_PORT` 自定义
- 使用 Hono 框架处理 HTTP 请求
- 请求进来后经过认证中间件校验 API key，然后路由到对应的格式转换处理器

### 2. ExtensionController + Adapters

管理 Roo Code、Cline 等 AI 编码扩展。通过适配器模式统一控制这些扩展的任务创建、消息发送、事件流。

- **ExtensionController** — 注册和管理所有适配器的中心枢纽
- **RooCodeAdapter** — 封装 Roo Code 扩展 API，内部有事件队列系统，实现生产者-消费者模式的实时事件流
- **ClineAdapter** — 封装 Cline 扩展管理
- **ExtensionBaseAdapter** — 抽象基类，提供扩展发现、激活、状态跟踪等通用功能

### 3. McpServer

通过 MCP 协议暴露一个工具 "Execute Roo Tasks"，允许 MCP 客户端并行执行多个 Roo Code 任务。

- 端口默认 `23334`，可通过环境变量 `AGENT_MAESTRO_MCP_PORT` 自定义
- 使用信号量控制并发数（1-20，默认 5）
- 实时流式返回每个任务的进度和结果

## 关键设计

| 设计点 | 说明 |
|--------|------|
| 认证 | API key 通过 VS Code 安全密钥存储管理，使用常量时间比较防止时序攻击 |
| 流式响应 | SSE 实时流式传输，将 VS Code LM API 的文本/工具调用分块转换为对应格式 |
| 懒激活 | 扩展只在需要时才激活 |
| 并发控制 | MCP 任务使用信号量限制最大并发数 |
| 事件队列 | RooCodeAdapter 解耦事件生产（RooCode）和消费（HTTP 客户端） |

## 项目结构

```
src/extension.ts          → 入口：激活/停用，连接 controller 和 servers
src/core/
  controller.ts           → ExtensionController：编排所有适配器
  ExtensionBaseAdapter.ts → 适配器抽象基类
  RooCodeAdapter.ts       → Roo Code 事件队列、任务创建、消息传递
  ClineAdapter.ts         → Cline 扩展管理
  McpTaskManager.ts       → MCP 并行任务执行
src/server/
  ProxyServer.ts          → Hono HTTP 服务器
  McpServer.ts            → FastMCP 服务器
  routes/                 → API 端点处理器
  schemas/                → Zod 请求/响应校验
  middleware/             → 认证中间件
src/commands/             → VS Code 命令注册
src/utils/                → 配置、日志、加密、模型匹配等工具函数
```
